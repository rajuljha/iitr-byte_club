# # SPDX-FileCopyrightText: Â© 2023 igor.mishchuk@carbonhealth.com

# # SPDX-License-Identifier: FSFAP

# name: Check diff for license with Fossology

# on:

# jobs:
#   check-license:
#     name: Check license
#     runs-on: ubuntu-22.04
#     steps:
#       - uses: actions/checkout@v3
#       - run: |
#           docker run --rm --name "fossologyscanner" -w "/opt/repo" -v ${PWD}:/opt/repo \
#             -e GITHUB_TOKEN=${{ github.token }} \
#             -e GITHUB_PULL_REQUEST=${{ github.event.number }} \
#             -e GITHUB_REPOSITORY=${{ github.repository }} \
#             -e GITHUB_REPO_URL=${{ github.repositoryUrl }} \
#             -e GITHUB_REPO_OWNER=${{ github.repository_owner }} \
#             -e GITHUB_API=${{ github.api_url }} \
#             -e GITHUB_ACTIONS \
#             fossology/fossology:scanner "/bin/fossologyscanner" nomos ojo

#   check-copyright:
#     name: Check copyright
#     runs-on: ubuntu-22.04
#     steps:
#       - uses: actions/checkout@v3
#       - run: |

name: Check diff for license with Fossology

on:
  pull_request:

jobs:
  build-docker-image:
    name: Build Docker Image
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3

      - name: Checkout specific branch of rajuljha/fossology repository
        uses: actions/checkout@v3
        with:
          repository: rajuljha/fossology
          ref: feat/automation/keyword_testing
          path: fossology-repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker buildx build --load -t rjknightmare/fo-ci-test:latest -f fossology-repo/utils/automation/Dockerfile.ci fossology-repo

      - name: Save Docker image as artifact
        run: |
          docker save rjknightmare/fo-ci-test:latest | gzip > rjknightmare-fo-ci-test-latest.tar.gz
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: rjknightmare-fo-ci-test-latest.tar.gz


  check-license:
    name: Check license
    runs-on: ubuntu-22.04
    needs: build-docker-image
    steps:
      - uses: actions/checkout@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: |
          gunzip -c rjknightmare-fo-ci-test-latest.tar.gz | docker load

      - name: Run Fossology Scanner
        run: |
          docker run --rm --name "fossologyscanner" -w "/opt/repo" -v ${PWD}:/opt/repo \
            -e GITHUB_TOKEN=${{ github.token }} \
            -e GITHUB_PULL_REQUEST=${{ github.event.number }} \
            -e GITHUB_REPOSITORY=${{ github.repository }} \
            -e GITHUB_REPO_URL=${{ github.repositoryUrl }} \
            -e GITHUB_REPO_OWNER=${{ github.repository_owner }} \
            -e GITHUB_API=${{ github.api_url }} \
            -e GITHUB_ACTIONS \
            fossology/fossology:scanner "/bin/fossologyscanner" nomos ojo

  check-copyright:
    name: Check copyright
    runs-on: ubuntu-22.04
    needs: build-docker-image
    steps:
      - uses: actions/checkout@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: |
          gunzip -c rjknightmare-fo-ci-test-latest.tar.gz | docker load

      - name : Load env variables
        run : |
          FILE_PATH=${{vars.KEYWORD_CONF_FILE_PATH || '' }}
          echo "File Path : $FILE_PATH"
          echo "Root: $GITHUB_WORKSPACE + $FILE_PATH"
          echo "${{ github.workspace }}/$FILE_PATH"
          cat "${{ github.workspace }}/$FILE_PATH"
      
      - name: Run Fossology Scanner with custom keywords
        if: ${{ vars.KEYWORD_CONF_FILE_PATH != '' }}
        run: |
          docker run --rm --name "fossologyscanner" -w "/opt/repo" -v ${PWD}:/opt/repo \
            -e GITHUB_TOKEN=${{ github.token }} \
            -e GITHUB_PULL_REQUEST=${{ github.event.number }} \
            -e GITHUB_REPOSITORY=${{ github.repository }} \
            -e GITHUB_API=${{ github.api_url }} \
            -e GITHUB_REPO_URL=${{ github.repositoryUrl }} \
            -e GITHUB_REPO_OWNER=${{ github.repository_owner }} \
            -e GITHUB_ACTIONS \
            rjknightmare/fo-ci-test:latest "/bin/fossologyscanner" copyright keyword --keyword-conf "$FILE_PATH"
      
      - name: Run fossology scanner
        if: ${{ vars.KEYWORD_CONF_FILE_PATH == '' }}
        run : |
          docker run --rm --name "fossologyscanner" -w "/opt/repo" -v ${PWD}:/opt/repo \
            -e GITHUB_TOKEN=${{ github.token }} \
            -e GITHUB_PULL_REQUEST=${{ github.event.number }} \
            -e GITHUB_REPOSITORY=${{ github.repository }} \
            -e GITHUB_API=${{ github.api_url }} \
            -e GITHUB_REPO_URL=${{ github.repositoryUrl }} \
            -e GITHUB_REPO_OWNER=${{ github.repository_owner }} \
            -e GITHUB_ACTIONS \
            rjknightmare/fo-ci-test:latest "/bin/fossologyscanner" copyright keyword
